<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:1.625rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.40625rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:calc(0.8125rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#4078c0;text-decoration:none;}a:hover,a:active{text-decoration:underline;}ol, ul{margin-left:16px;}</style><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><title data-react-helmet="true">9. The Pool Object | Another C Library</title><meta data-react-helmet="true" name="description" content="A documentation site for Another C Library."/><meta data-react-helmet="true" property="og:title" content="9. The Pool Object"/><meta data-react-helmet="true" property="og:description" content="A documentation site for Another C Library."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Daniel Curtis"/><meta data-react-helmet="true" name="twitter:title" content="9. The Pool Object"/><meta data-react-helmet="true" name="twitter:description" content="A documentation site for Another C Library."/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="shortcut icon" href="/icons/icon-48x48.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="generator" content="Gatsby 2.18.14"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=b48ffc73e97be239d297f69a5b2c56e5"/><style data-href="/styles.77dda24363f4e378cb42.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}a{text-decoration:none;cursor:pointer;color:#3182ce}a:hover{text-decoration:underline}button:hover{-webkit-transition:.6s;transition:.6s;-webkit-filter:brightness(115%);filter:brightness(115%)}nav{display:flex;align-items:center}li{margin-bottom:3px}pre[class*=language]{overflow-x:scroll}:not(pre)>code[class*=language],pre[class*=language]{border-radius:0;background:#f6f8fa;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;text-shadow:none}:not(pre)>code[class*=language]{color:#000;padding:3px}.Footer{max-width:1200px;margin:30px auto;display:flex;justify-content:space-between}.Flex{display:grid;grid-template-columns:auto auto;grid-column-gap:50px}.Content{max-width:950px;width:72vw}@media only screen and (max-width:600px){.Footer,nav{flex-direction:column}.Flex{grid-template-columns:auto}.Sidebar{display:none}.Content{width:100%}}</style><link as="script" rel="preload" href="/component---src-templates-ebook-page-js-4f86bfce78e35e0955d6.js"/><link as="script" rel="preload" href="/commons-112db262b175fed05b80.js"/><link as="script" rel="preload" href="/app-fb5291d31b0f12597e81.js"/><link as="script" rel="preload" href="/styles-a8f8354e20700922ebe9.js"/><link as="script" rel="preload" href="/webpack-runtime-277776b5a5692f7fc3b0.js"/><link as="fetch" rel="preload" href="/page-data/ebook/9-pool/page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="background-color:white"><header style="position:sticky;top:0;background-color:#1A202C;z-index:1"><nav style="margin:auto;max-width:1200px"><a style="color:white;font-size:1.25rem;padding:1rem 1.5rem;font-family:-apple-system,&#x27;BlinkMacSystemFont&#x27;,&#x27;Segoe UI&#x27;,&#x27;Roboto&#x27;,&#x27;Oxygen&#x27;,&#x27;Ubuntu&#x27;,&#x27;Cantarell&#x27;,&#x27;Fira Sans&#x27;,&#x27;Droid Sans&#x27;,&#x27;Helvetica Neue&#x27;,sans-serif" href="/"><span style="font-weight:700">Another C Library</span></a><a style="color:white;font-size:1.25rem;padding:1rem 1.5rem;font-family:-apple-system,&#x27;BlinkMacSystemFont&#x27;,&#x27;Segoe UI&#x27;,&#x27;Roboto&#x27;,&#x27;Oxygen&#x27;,&#x27;Ubuntu&#x27;,&#x27;Cantarell&#x27;,&#x27;Fira Sans&#x27;,&#x27;Droid Sans&#x27;,&#x27;Helvetica Neue&#x27;,sans-serif" href="/docs/">Documentation</a><a style="color:#38A169;font-size:1.25rem;padding:1rem 1.5rem;font-family:-apple-system,&#x27;BlinkMacSystemFont&#x27;,&#x27;Segoe UI&#x27;,&#x27;Roboto&#x27;,&#x27;Oxygen&#x27;,&#x27;Ubuntu&#x27;,&#x27;Cantarell&#x27;,&#x27;Fira Sans&#x27;,&#x27;Droid Sans&#x27;,&#x27;Helvetica Neue&#x27;,sans-serif;border-bottom:solid 4px #2F855A;background-color:#2D3748" class="" href="/ebook/">A C eBook</a><a style="color:white;font-size:1.25rem;padding:1rem 1.5rem;font-family:-apple-system,&#x27;BlinkMacSystemFont&#x27;,&#x27;Segoe UI&#x27;,&#x27;Roboto&#x27;,&#x27;Oxygen&#x27;,&#x27;Ubuntu&#x27;,&#x27;Cantarell&#x27;,&#x27;Fira Sans&#x27;,&#x27;Droid Sans&#x27;,&#x27;Helvetica Neue&#x27;,sans-serif" target="_blank" rel="noopener noreferrer" href="https://github.com/contactandyc/another-c-library">Github <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" style="padding-top:5px" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M576 24v127.984c0 21.461-25.96 31.98-40.971 16.971l-35.707-35.709-243.523 243.523c-9.373 9.373-24.568 9.373-33.941 0l-22.627-22.627c-9.373-9.373-9.373-24.569 0-33.941L442.756 76.676l-35.703-35.705C391.982 25.9 402.656 0 424.024 0H552c13.255 0 24 10.745 24 24zM407.029 270.794l-16 16A23.999 23.999 0 0 0 384 303.765V448H64V128h264a24.003 24.003 0 0 0 16.97-7.029l16-16C376.089 89.851 365.381 64 344 64H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V287.764c0-21.382-25.852-32.09-40.971-16.97z"></path></svg></a></nav></header><main><div style="margin:0 auto;max-width:1200px;display:flex"><div style="color:black;margin:0;padding:20px" class="Content"><h1>9. The Pool Object</h1><div><p>Copyright 2019 Andy Curtis &#x26; Daniel Curtis</p>
<h1 id="the-pool-object"><a href="#the-pool-object" aria-label="the pool object permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Pool Object</h1>
<p>What if our object could keep track of allocations and free memory for us?  This is generally the basis for languages that use garbage collection.  I'm going to illustrate how to build several objects which greatly reduce the number of calls to malloc and free (and reduce the risk that you will have memory leaks).  </p>
<p>The first is an object which I've used for almost my whole career.  I've called it a pool.  The basic idea with this object is that you can allocate and clear.  It has no free function.  When you clear, you clear all of the memory that has been previously allocated from the pool. Internally, it is very efficient in that all it typically does is reset a counter to zero.  The base interface will look something like the following.</p>
<p>pool.h</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _pool_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _pool_H</span>

<span class="token keyword">struct</span> <span class="token class-name">pool_s</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">pool_s</span> pool_t<span class="token punctuation">;</span>

pool_t <span class="token operator">*</span><span class="token function">pool_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pool_malloc</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pool_calloc</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">pool_strdup</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">pool_clear</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">pool_destroy</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre></div>
<p>There is no free method.  You can call the allocation methods as often as you like, and they will remain valid until pool<em>clear or pool</em>destroy is called.</p>
<h1 id="the-simplest-implementation"><a href="#the-simplest-implementation" aria-label="the simplest implementation permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Simplest Implementation</h1>
<p>When approaching algorithms, it is often a good idea to think about the simplest implementation.  This implementation doesn't need to be efficient.  It can serve to prove that a more complicated version achieves the same result.</p>
<p>Below describes a simple implementation of the pool interface:</p>
<ul>
<li>Have each allocation saved in a singly linked list on the pool_s structure.  </li>
<li>The clear method could free all of the memory in the linked list.</li>
<li>The destroy could call clear, and then free the pool_s object itself.</li>
<li>Each allocation would require it's own link structure.</li>
</ul>
<p>A singly linked list usually is linked to from a structure and then chained together using a member called next.  Each allocation would be placed in its own structure and linked to by the pool_s structure through the member head.  The two objects and implementation would probably look like the following.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">pool_node_s</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>m<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">pool_node_s</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> pool_node_t<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">pool_s</span> <span class="token punctuation">{</span>
  pool_node_t <span class="token operator">*</span>head<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

pool_t <span class="token operator">*</span><span class="token function">pool_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pool_t <span class="token operator">*</span>r <span class="token operator">=</span> <span class="token punctuation">(</span>pool_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  r<span class="token operator">-></span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pool_malloc</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pool_node_t <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>pool_node_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool_node_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  n<span class="token operator">-></span>m <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  n<span class="token operator">-></span>next <span class="token operator">=</span> h<span class="token operator">-></span>head<span class="token punctuation">;</span>
  h<span class="token operator">-></span>head <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token operator">-></span>m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pool_calloc</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token function">pool_malloc</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">pool_strdup</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pool_malloc</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pool_clear</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pool_node_t <span class="token operator">*</span>n <span class="token operator">=</span> h<span class="token operator">-></span>head<span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pool_node_t <span class="token operator">*</span>next <span class="token operator">=</span> n<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>n<span class="token operator">-></span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    n <span class="token operator">=</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pool_destroy</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pool_clear</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We could allocate the desired memory and the pool<em>node</em>t structure together.  If we did that, we wouldn't need the void *m parameter, and the memory requested could just exist after the pool<em>node</em>t structure.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">pool_node_s</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">pool_node_s</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> pool_node_t<span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pool_malloc</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pool_node_t <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>pool_node_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool_node_t<span class="token punctuation">)</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  n<span class="token operator">-></span>next <span class="token operator">=</span> h<span class="token operator">-></span>head<span class="token punctuation">;</span>
  h<span class="token operator">-></span>head <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pool_clear</span><span class="token punctuation">(</span>pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pool_node_t <span class="token operator">*</span>n <span class="token operator">=</span> h<span class="token operator">-></span>head<span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pool_node_t <span class="token operator">*</span>next <span class="token operator">=</span> n<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token comment">// free(n->m); // this is no longer needed</span>
    <span class="token function">free</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    n <span class="token operator">=</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Using the simple structure above, our allocations can be tracked and cleared by the pool object instead of requiring the application to remember where each allocation started from.</p>
<h1 id="a-better-implementation"><a href="#a-better-implementation" aria-label="a better implementation permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A better implementation</h1>
<p>The above implementation does save us from needing to free memory, but it doesn't do much more.  The pool object that exists in the src directory is listed below:</p>
<p>src/ac_pool.h</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _ac_pool_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _ac_pool_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ac_allocator.h"</span></span>

<span class="token keyword">struct</span> <span class="token class-name">ac_pool_s</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ac_pool_s</span> ac_pool_t<span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_init will create a working space of size bytes */</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _AC_DEBUG_MEMORY_</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO("ac_pool"))</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size)</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment">/* ac_pool_clear will make all of the pool's memory reusable.  If the
  initial block was exceeded and additional blocks were added, those blocks
  will be freed. */</span>
<span class="token keyword">void</span> <span class="token function">ac_pool_clear</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_destroy frees up all memory associated with the pool object */</span>
<span class="token keyword">void</span> <span class="token function">ac_pool_destroy</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_set_minimum_growth_size alters the minimum size of growth blocks.
   This is particularly useful if you don't expect the pool's block size to be
   exceeded by much, and you don't want the default, which would be to use the
   original block size for the new block (effectively doubling memory usage). */</span>
<span class="token keyword">void</span> <span class="token function">ac_pool_set_minimum_growth_size</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_alloc allocates len uninitialized bytes which are aligned. */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">ac_pool_alloc</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_alloc allocates len uninitialized bytes which are unaligned. */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">ac_pool_ualloc</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_alloc allocates len zero'd bytes which are aligned. */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">ac_pool_calloc</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_strdup allocates a copy of the string p.  The memory will be
  unaligned.  If you need the memory to be aligned, consider using ac_pool_dup
  like char *s = ac_pool_dup(pool, p, strlen(p)+1); */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ac_pool_strdup</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_dup allocates a copy of the data.  The memory will be aligned. */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">ac_pool_dup</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_dup allocates a copy of the data.  The memory will be unaligned. */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">ac_pool_udup</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_strdupf allocates a copy of the formatted string p. */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ac_pool_strdupf</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_strdupvf allocates a copy of the formatted string p. This is
  particularly useful if you wish to extend another object which uses pool as
  its base.  */</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ac_pool_strdupvf</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> va_list args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_size returns the number of bytes that have been allocated from any
  of the alloc calls above.  */</span>
size_t <span class="token function">ac_pool_size</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ac_pool_used returns the number of bytes that have been allocated by the
  pool itself.  This will always be greater than ac_pool_size as there is
  overhead for the structures, and this is independent of any allocating calls.
*/</span>
size_t <span class="token function">ac_pool_used</span><span class="token punctuation">(</span>ac_pool_t <span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"impl/ac_pool.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre></div>
<p>A few significant changes are added to the interface.</p>
<ul>
<li>Everything uses the ac_ prefix.</li>
<li>The ac_allocator object is used for allocation.</li>
<li>ac<em>pool</em>init is changed to a macro to support memory debugging.</li>
<li>ac<em>pool</em>init takes in a size (to support allocating in larger chunks)</li>
<li>ac<em>pool</em>malloc is changed to ac<em>pool</em>alloc.</li>
<li>ac<em>pool</em>ualloc supports unaligned allocation.</li>
<li>ac<em>pool</em>dup and sla<em>pool</em>udup copy binary data.</li>
<li>ac<em>pool</em>strdupf/ac<em>pool</em>strdupvf support working with format strings.</li>
<li>ac<em>pool</em>size gets the overall number of bytes that have been allocated.</li>
<li>ac<em>pool</em>used gets the overall number of bytes that have been allocated internally.</li>
<li>impl/ac_pool.h is used to inline a number of the functions for performance.</li>
<li>some of the functions are declared as static inline because they are implemented in the impl/ac_pool.h header file.</li>
</ul>
<p>By this point, the code below should look pretty familiar.  Files are included, ac<em>pool</em>t is defined, and the <em>ac</em>pool_H is defined to prevent the contents of this file from being included more than once.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _ac_pool_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _ac_pool_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ac_allocator.h"</span></span>

<span class="token keyword">struct</span> <span class="token class-name">ac_pool_s</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ac_pool_s</span> ac_pool_t<span class="token punctuation">;</span></code></pre></div>
<p>Because this object will use the ac_allocator for debugging memory, the following is needed to define the init function.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/* ac_pool_init will create a working space of size bytes */</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _AC_DEBUG_MEMORY_</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO("ac_pool"))</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size)</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre></div>
<p>If we weren't using the ac_allocator, our init call would look like this:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>If you refer back to the end of the <a href="7_allocator.md">allocator</a> code, there is an explanation of similar code for the timer object conversion.</p>
<p>Replace</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">ac_pool_t <span class="token operator">*</span><span class="token function">ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>with</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifdef</span> _AC_DEBUG_MEMORY_</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO("ac_pool"))</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size)</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre></div>
<p>The above code has two basic cases:  one where <em>AC</em>DEBUG<em>MEMORY</em> is defined, and the other where it is not (#else).  It may be easier to break this into a couple of steps.</p>
<ol>
<li>convert the init function to be prefixed with an underscore</li>
</ol>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">ac_pool_t <span class="token operator">*</span><span class="token function">ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>becomes</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<ol start="2">
<li>
<p>create a macro which defines ac<em>pool</em>init as <em>ac</em>pool_init</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size)</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
</li>
<li>
<p>define the macro if logic with the else part filled in.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifdef</span> _AC_DEBUG_MEMORY_</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size)</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre></div>
</li>
<li>
<p>Add const char *caller to the debug version of <em>ac</em>pool_init</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
</li>
<li>
<p>define the macro to call the init function.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO("ac_pool"))</span></code></pre></div>
</li>
<li>
<p>put the two calls in the #ifdef <em>AC</em>DEBUG<em>MEMORY</em> section.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifdef</span> _AC_DEBUG_MEMORY_</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO("ac_pool"))</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> ac_pool_init(size) _ac_pool_init(size)</span>
ac_pool_t <span class="token operator">*</span><span class="token function">_ac_pool_init</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre></div>
</li>
</ol>
<p>A common use case for the pool is to allocate a bunch of times and then clear and repeat.  For example, if you were responding to queries from a search engine, you might want to use this object and allocate a bunch of times for parsing the query and building a response.  Once the response has been written, the pool can be cleared and used for the next query.  The pool would likely need a certain amount of bytes to satisfy the vast majority of the queries.  Given this use, it makes sense for the pool to allocate enough bytes in a single block, and then just to dole out the memory via its allocation methods.  If the single block isn't big enough for all of the allocations, overflow blocks will be allocated.  When the pool is cleared, the overflow blocks will be freed.  The main block will remain, and the counter inside the pool will be reset to zero.  If we make the pool too small, the overflow blocks will continuously get used.  If we make it too big, we waste memory.</p>
<h1 id="to-be-continued"><a href="#to-be-continued" aria-label="to be continued permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TO BE CONTINUED</h1>
<h1 id="binary-search-trees"><a href="#binary-search-trees" aria-label="binary search trees permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="10_binary_search_trees.md">Binary Search Trees</a></h1>
<p><a href="../README.md">Table of Contents</a>  - Copyright 2019 Andy Curtis</p></div></div><div style="font-family:-apple-system,&#x27;BlinkMacSystemFont&#x27;,&#x27;Segoe UI&#x27;,&#x27;Roboto&#x27;,&#x27;Oxygen&#x27;,&#x27;Ubuntu&#x27;,&#x27;Cantarell&#x27;,&#x27;Fira Sans&#x27;,&#x27;Droid Sans&#x27;,&#x27;Helvetica Neue&#x27;,sans-serif;width:400px;height:100vh;padding:15px;color:#1E4E8C;position:sticky;top:62px;border-left:solid 1px #EDF2F7" class="Sidebar"><div><div><a href="/ebook/1-getting-started">1. Getting Started</a></div><div><a href="/ebook/2-timing">2. Timing Your Code</a></div><div><a href="/ebook/3-buffer">3. The Buffer Object</a></div><div><a href="/ebook/4-linked-lists">4. Linked Lists</a></div><div><a href="/ebook/5-threads">5. Introducing Threads</a></div><div><a href="/ebook/6-macros">6. Macros</a></div><div><a href="/ebook/7-allocator">7. The Global Allocator Object</a></div><div><a href="/ebook/8-allocator-implementation">8. The Global Allocator Implementation</a></div><div><a href="/ebook/9-pool">9. The Pool Object</a></div><div><a href="/ebook/10-binary-search-trees">10. Binary Search Trees</a></div><div><a href="/ebook/11-balancing-binary-search-trees">11. Balancing Binary Search Trees</a></div><div><a href="/ebook/12-red-black-tree">12. The Red-Black Tree</a></div><div><a href="/ebook/13-map">13. The Map Object</a></div><div><a href="/ebook/14-set-and-multimap">14. The Set and Multimap</a></div></div></div></div></main><footer style="background-color:#1A202C;padding:10px;color:white;font-family:-apple-system,&#x27;BlinkMacSystemFont&#x27;,&#x27;Segoe UI&#x27;,&#x27;Roboto&#x27;,&#x27;Oxygen&#x27;,&#x27;Ubuntu&#x27;,&#x27;Cantarell&#x27;,&#x27;Fira Sans&#x27;,&#x27;Droid Sans&#x27;,&#x27;Helvetica Neue&#x27;,sans-serif"><div class="Footer"><div><h1 style="margin:10px 0">Another C Library</h1><p style="margin-bottom:15px">© <!-- -->2019<!-- --> Andy Curtis &amp; Daniel Curtis</p><ul style="list-style:none;margin-left:0"><li><a style="color:#3182CE" href="/contact">Contact</a></li><li><a style="color:#3182CE" href="/contributing">Contributing</a></li><li><a style="color:#3182CE" href="/license">License</a></li></ul></div><div><h2 style="margin:10px auto">A C eBook</h2><ul style="list-style:none;margin-left:0"><li><a href="/ebook/1-getting-started">1. Getting Started</a></li><li><a href="/ebook/2-timing">2. Timing Your Code</a></li><li><a href="/ebook/3-buffer">3. The Buffer Object</a></li><li><a href="/ebook/4-linked-lists">4. Linked Lists</a></li><li><a href="/ebook/5-threads">5. Introducing Threads</a></li><li><a href="/ebook/6-macros">6. Macros</a></li><li><a href="/ebook/7-allocator">7. The Global Allocator Object</a></li><li><a href="/ebook/8-allocator-implementation">8. The Global Allocator Implementation</a></li><li><a href="/ebook/9-pool">9. The Pool Object</a></li><li><a href="/ebook/10-binary-search-trees">10. Binary Search Trees</a></li><li><a href="/ebook/11-balancing-binary-search-trees">11. Balancing Binary Search Trees</a></li><li><a href="/ebook/12-red-black-tree">12. The Red-Black Tree</a></li><li><a href="/ebook/13-map">13. The Map Object</a></li><li><a href="/ebook/14-set-and-multimap">14. The Set and Multimap</a></li></ul></div><div><h2 style="margin:10px auto">Resources</h2><ul style="list-style:none;margin-left:0"><li><a href="https://medium.com/software-design/why-software-developers-should-care-about-cpu-caches-8da04355bb8a" target="_blank" rel="noopener noreferrer" style="color:#3182CE">Why software developers should care about CPU caches <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M576 24v127.984c0 21.461-25.96 31.98-40.971 16.971l-35.707-35.709-243.523 243.523c-9.373 9.373-24.568 9.373-33.941 0l-22.627-22.627c-9.373-9.373-9.373-24.569 0-33.941L442.756 76.676l-35.703-35.705C391.982 25.9 402.656 0 424.024 0H552c13.255 0 24 10.745 24 24zM407.029 270.794l-16 16A23.999 23.999 0 0 0 384 303.765V448H64V128h264a24.003 24.003 0 0 0 16.97-7.029l16-16C376.089 89.851 365.381 64 344 64H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V287.764c0-21.382-25.852-32.09-40.971-16.97z"></path></svg></a></li><li><a href="https://github.com/contactandyc/another-c-library/blob/master/docs/tips.md#create-multiline-macro-in-c" target="_blank" rel="noopener noreferrer" style="color:#3182CE">Helpful Tips for Formatting <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M576 24v127.984c0 21.461-25.96 31.98-40.971 16.971l-35.707-35.709-243.523 243.523c-9.373 9.373-24.568 9.373-33.941 0l-22.627-22.627c-9.373-9.373-9.373-24.569 0-33.941L442.756 76.676l-35.703-35.705C391.982 25.9 402.656 0 424.024 0H552c13.255 0 24 10.745 24 24zM407.029 270.794l-16 16A23.999 23.999 0 0 0 384 303.765V448H64V128h264a24.003 24.003 0 0 0 16.97-7.029l16-16C376.089 89.851 365.381 64 344 64H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V287.764c0-21.382-25.852-32.09-40.971-16.97z"></path></svg></a></li><li><a href="https://mitpress.mit.edu/books/introduction-algorithms-third-edition" target="_blank" rel="noopener noreferrer" style="color:#3182CE">Introduction to Alogorithms <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M576 24v127.984c0 21.461-25.96 31.98-40.971 16.971l-35.707-35.709-243.523 243.523c-9.373 9.373-24.568 9.373-33.941 0l-22.627-22.627c-9.373-9.373-9.373-24.569 0-33.941L442.756 76.676l-35.703-35.705C391.982 25.9 402.656 0 424.024 0H552c13.255 0 24 10.745 24 24zM407.029 270.794l-16 16A23.999 23.999 0 0 0 384 303.765V448H64V128h264a24.003 24.003 0 0 0 16.97-7.029l16-16C376.089 89.851 365.381 64 344 64H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V287.764c0-21.382-25.852-32.09-40.971-16.97z"></path></svg></a></li></ul></div></div></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ebook/9-pool/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-fb5291d31b0f12597e81.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-44b37c3d0621676eebb5.js"],"component---src-templates-ebook-page-js":["/component---src-templates-ebook-page-js-4f86bfce78e35e0955d6.js"],"component---src-pages-404-js":["/component---src-pages-404-js-43d144517b29d5889d0f.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-75a1998efa7b299455c5.js"],"component---src-pages-contributing-js":["/component---src-pages-contributing-js-e9dc3e8dd486904c9d93.js"],"component---src-pages-docs-js":["/component---src-pages-docs-js-2cd44d59460d18e08591.js"],"component---src-pages-ebook-js":["/component---src-pages-ebook-js-d3f2fceb0db47cb8c846.js"],"component---src-pages-index-js":["/component---src-pages-index-js-0152ebc0b4226a6515fa.js"],"component---src-pages-license-js":["/component---src-pages-license-js-a84ed4b0fd7b4af796e8.js"]};/*]]>*/</script><script src="/webpack-runtime-277776b5a5692f7fc3b0.js" async=""></script><script src="/styles-a8f8354e20700922ebe9.js" async=""></script><script src="/app-fb5291d31b0f12597e81.js" async=""></script><script src="/commons-112db262b175fed05b80.js" async=""></script><script src="/component---src-templates-ebook-page-js-4f86bfce78e35e0955d6.js" async=""></script></body></html>