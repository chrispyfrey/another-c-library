{"componentChunkName":"component---src-templates-md-page-js","path":"/ebook/12-red-black-tree/","result":{"data":{"site":{"siteMetadata":{"title":"Another C Library"}},"markdownRemark":{"id":"f2d454de-1f32-50a9-91a3-f3ed53776f11","html":"<h1 id=\"the-red-black-tree\"><a href=\"#the-red-black-tree\" aria-label=\"the red black tree permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Red-Black Tree</h1>\n<p>The red-black tree is a mostly balanced binary search tree that was invented by Leonidas J. Guibas and Robert Sedgewick.</p>\n<h2 id=\"the-properties-of-a-red-black-tree\"><a href=\"#the-properties-of-a-red-black-tree\" aria-label=\"the properties of a red black tree permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The properties of a red-black tree</h2>\n<p>Red–black tree Properties (<a href=\"https://en.wikipedia.org/wiki/Red%E2%80%93black_tree\">https://en.wikipedia.org/wiki/Red–black_tree</a>)</p>\n<ol>\n<li>Each node is either red or black.</li>\n<li>The root is black.</li>\n<li>All leaves (NIL) are black.</li>\n<li>If a node is red, then both its children are black.</li>\n<li>Every path from a given node to any of its descendant NIL nodes contains the same number of black nodes.</li>\n</ol>\n<p>My additional rules for clarification which are based upon the first 5 rules.</p>\n<ul>\n<li>If a node has one child, the child must be red</li>\n<li>If a node has two children, one or both of the children can be red if the parent is black</li>\n<li>If a node is red, it must have either two children who are black or no children at all.</li>\n<li>The parent of a red node must be black</li>\n<li>The black height of any leaf node must be the same (another way of stating 5)</li>\n<li>A red-black tree often will have many more black nodes than red nodes.  This is okay and expected.  The red node is an indication that the tree may be somehow out of balance.  It is possible to have more red nodes than black nodes, but it isn't typical.</li>\n<li>A red-black tree has a worst case of a 2logN depth but is likely to maintain a logN depth or be very close to it.</li>\n</ul>\n<p>The red-black tree is balanced through rotations and changing colors, which were discussed in <a href=\"../11-balancing-binary-search-trees/index.md\">Balancing Binary Search Trees</a>.  Make sure the tree_operations tool is built from the last section if you want to follow along.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd $ac/illustrations/11_balancing_binary_search_trees/2_tree_operations\nmake</code></pre></div>\n<p>Then run</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations ABC\nB1\n| \\\n|  (C1)\n|      \n(A1)\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\nq</code></pre></div>\n<p>To make sure that it is working.</p>\n<p>The code for this section is found in <i>illustrations/12<em>red</em>black<em>tree/1</em>red<em>black</em>tree</i></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd $ac/illustrations/12_red_black_tree/1_red_black_tree\nmake</code></pre></div>\n<p>Most of the code is in red<em>black</em>tree.c</p>\n<h2 id=\"testing-the-red-black-tree-properties\"><a href=\"#testing-the-red-black-tree-properties\" aria-label=\"testing the red black tree properties permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Testing the red-black tree properties</h2>\n<p>When an algorithm can be tested through a function, it is often a good idea to write such a function.  Functions like the one to follow should be pretty straight-forward, given the rules above.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">bool <span class=\"token function\">test_red_black_rules</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>pool<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* an empty tree is valid */</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>root<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span>\n  bool success <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/* the root is black */</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>root<span class=\"token operator\">-></span>color <span class=\"token operator\">!=</span> BLACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"The root is not black!\\n\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  node_t <span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> <span class=\"token function\">node_first</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> black_nodes <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  node_t <span class=\"token operator\">*</span>first_black_leaf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n  node_t <span class=\"token operator\">*</span>sn <span class=\"token operator\">=</span> n<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>left <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* only consider leaf nodes */</span>\n      black_nodes <span class=\"token operator\">=</span> <span class=\"token function\">count_black_nodes</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      first_black_leaf <span class=\"token operator\">=</span> n<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    n <span class=\"token operator\">=</span> <span class=\"token function\">node_next</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  n <span class=\"token operator\">=</span> sn<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* check if one child and that child is red */</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> bn <span class=\"token operator\">=</span> <span class=\"token function\">count_black_nodes</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>bn <span class=\"token operator\">!=</span> black_nodes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n          <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has a NULL left child with a different black height than \"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>first_black_leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">int</span> bn <span class=\"token operator\">=</span> <span class=\"token function\">count_black_nodes</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>bn <span class=\"token operator\">!=</span> black_nodes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has a NULL right child with a different black height than \"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>first_black_leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>left <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>right <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>color <span class=\"token operator\">!=</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has one left child and it isn't red\\n\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>left <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">-></span>right <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">!=</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has one right child and it isn't red\\n\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>left <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has a red left child and is red\\n\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>right <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has a red right child and is red\\n\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>parent <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">-></span>parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has a red parent and is red\\n\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>left <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>n<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* only consider leaf nodes */</span>\n      <span class=\"token keyword\">int</span> bn <span class=\"token operator\">=</span> <span class=\"token function\">count_black_nodes</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>black_nodes <span class=\"token operator\">!=</span> bn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        success <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\" has a different black height than \"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">print_node_with_color</span><span class=\"token punctuation\">(</span>first_black_leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    n <span class=\"token operator\">=</span> <span class=\"token function\">node_next</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> success<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"insert\"><a href=\"#insert\" aria-label=\"insert permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Insert</h2>\n<p>The red-black tree functions in many ways are similar to the binary search tree.  Iterating and finding are the same.  Erasing and inserting are done in virtually the same way, except once an item is inserted or erased, the color must be fixed.  The difference between the binary search tree and red-black tree node_insert is shown below.</p>\n<p>binary<em>search</em>tree.c</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">bool <span class=\"token function\">node_insert</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>node_to_insert<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> root<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>parent <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    parent <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>n<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node_to_insert<span class=\"token operator\">-></span>key <span class=\"token operator\">&lt;</span> parent<span class=\"token operator\">-></span>key<span class=\"token punctuation\">)</span>\n      n <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node_to_insert<span class=\"token operator\">-></span>key <span class=\"token operator\">></span> parent<span class=\"token operator\">-></span>key<span class=\"token punctuation\">)</span>\n      n <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span>\n      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  node_to_insert<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">;</span>\n  node_to_insert<span class=\"token operator\">-></span>left <span class=\"token operator\">=</span> node_to_insert<span class=\"token operator\">-></span>right <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> node_to_insert<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>red<em>black</em>tree.c</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">red_black_insert</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbool <span class=\"token function\">node_insert</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>node_to_insert<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> root<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>parent <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    parent <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>n<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node_to_insert<span class=\"token operator\">-></span>key <span class=\"token operator\">&lt;</span> parent<span class=\"token operator\">-></span>key<span class=\"token punctuation\">)</span>\n      n <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node_to_insert<span class=\"token operator\">-></span>key <span class=\"token operator\">></span> parent<span class=\"token operator\">-></span>key<span class=\"token punctuation\">)</span>\n      n <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span>\n      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  node_to_insert<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">;</span>\n  node_to_insert<span class=\"token operator\">-></span>left <span class=\"token operator\">=</span> node_to_insert<span class=\"token operator\">-></span>right <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> node_to_insert<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">red_black_insert</span><span class=\"token punctuation\">(</span>node_to_insert<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The difference is:</p>\n<p>red<em>black</em>tree.c</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">red_black_insert</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token function\">red_black_insert</span><span class=\"token punctuation\">(</span>node_to_insert<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The red<em>black</em>insert method in red<em>black</em>tree.c</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">red_black_insert</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n  node_t <span class=\"token operator\">*</span>parent<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>grandparent<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>uncle<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    parent <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      node<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n      node<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n    grandparent <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>grandparent<span class=\"token operator\">-></span>left <span class=\"token operator\">==</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      uncle <span class=\"token operator\">=</span> grandparent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>uncle <span class=\"token operator\">&amp;&amp;</span> uncle<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// recolor grandparent</span>\n        grandparent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n        parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> uncle<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n        node <span class=\"token operator\">=</span> grandparent<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>right <span class=\"token operator\">==</span> node<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">rotate_right_and_swap_colors</span><span class=\"token punctuation\">(</span>grandparent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      uncle <span class=\"token operator\">=</span> grandparent<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>uncle <span class=\"token operator\">&amp;&amp;</span> uncle<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// recolor grandparent</span>\n        grandparent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n        parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> uncle<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n        node <span class=\"token operator\">=</span> grandparent<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>left <span class=\"token operator\">==</span> node<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">rotate_left_and_swap_colors</span><span class=\"token punctuation\">(</span>grandparent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It is assumed that node is linked into its proper parent and that the node is a leaf node with left and right pointers set to NULL.  The red-black tree always initially paints the given node red.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">red_black_insert</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span></code></pre></div>\n<p>The insert operation will need to look at the parent, the grandparent, and the uncle (the sibling of the parent).  Declare these variables for later use.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  node_t <span class=\"token operator\">*</span>parent<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>grandparent<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>uncle<span class=\"token punctuation\">;</span></code></pre></div>\n<p>The red-black tree insert may need to recurse.  Many recursion problems (this one included) can be written as a loop.  The loop will continue forever until a break is called.  </p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  parent <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">;</span></code></pre></div>\n<p>At this point in the code, the node is always red.</p>\n<p>The first check is to see if the given node is the root node.  If the node doesn't have a parent, it is a root node.  Root nodes are colored black, and then we are done (break out of the while loop).    </p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    node<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n    node<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>If the parent is black, we are done as having a red leaf following a black parent is always valid.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The parent is valid, and it must be red (as it must be red or black, and it was determined to not be black in the last block of code).  It is a violation of the red-black tree to have two red nodes in a row.  Get the grandparent (the parent's parent).</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  grandparent <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">;</span></code></pre></div>\n<p>The red-black tree insert operation considers the node's uncle's color.  The uncle would be the grandparent's other child.  If the grandparent->left == parent, then the uncle is the right node.  Otherwise, the uncle is the left node.  The else block is a mirror of the if block, switching every instance of left with right.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>grandparent<span class=\"token operator\">-></span>left <span class=\"token operator\">==</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    uncle <span class=\"token operator\">=</span> grandparent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    uncle <span class=\"token operator\">=</span> grandparent<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The next case to test is if the uncle exists and the uncle's color is red.  At this point, the parent and the uncle are both red.  The red-black tree needs to maintain a constant black height.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations FDGBE\nF1\n| \\\n|  G2\n|    \nD2\n| \\\n|  (E2)\n|      \n(B2)\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\ni A\nF1\n| \\\n|  G2\n|    \nD2\n| \\\n|  (E2)\n|      \n(B2)\n|   \n(A2)\n\n(A2) has a red parent and is red\n(B2) has a red left child and is red\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit</code></pre></div>\n<p>Before inserting node (A2), notice that the leaf nodes (B2), (E2), and G2 all have a black height of 2, meaning that there are only 2 black nodes in the path from the root to each of the leaf nodes.  If you recolor (B2) and (E2) black and change D2 to be red, it doesn't change the black height of any of the leaf nodes.</p>\n<p>In the tool, you can type:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">c D</code></pre></div>\n<p>to recolor and get the following partial output</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">F1\n| \\\n|  G2\n|    \n(D1)\n|   \\\nB2   E2\n|      \n(A2)</code></pre></div>\n<p>Notice that in this case, the recoloring created a valid red-black tree.  The black height is 2 to every leaf node.  The root is black.  There are not two red nodes in a row.  In the one case (A2) where a node only has a single child, the child is red.</p>\n<p>To recap, if the parent and uncle are red, paint the parent and uncle black and the grandparent red.  However, the grandparent's parent possibly was also red.  To handle this case, we can repeat all of the tests recursively. Since the recursion is simple, continuing in a while loop works by changing the node to the grandparent. The grandparent which painted red to maintain the rule that the loop always starts with a red node.  The code is below:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>grandparent<span class=\"token operator\">-></span>left <span class=\"token operator\">==</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    uncle <span class=\"token operator\">=</span> grandparent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>uncle <span class=\"token operator\">&amp;&amp;</span> uncle<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      grandparent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n      parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> uncle<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n      node <span class=\"token operator\">=</span> grandparent<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The following example adds the letter 0 (zero) to the left of (A2).  This creates the same case as above, but when recoloring happens (c B), (B1) and (D1) are both red. D becomes the new node. It is an example where recoloring creates a parent and child, which are both red.</p>\n<p>This is illustrated by the tool below.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations FDGBEABCDEFGHI\nF1\n| \\\n|  H2\n|  | \\\n|  |  (I2)\n|  |      \n|  (G2)\n|      \n(D1)\n|   \\\nB2   E2\n| \\    \n|  (C2)\n|      \n(A2)\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\ni 0\nF1\n| \\\n|  H2\n|  | \\\n|  |  (I2)\n|  |      \n|  (G2)\n|      \n(D1)\n|   \\\nB2   E2\n| \\    \n|  (C2)\n|      \n(A2)\n|   \n(02)\n\n(02) has a red parent and is red\n(A2) has a red left child and is red\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\nc B\nF1\n| \\\n|  H2\n|  | \\\n|  |  (I2)\n|  |      \n|  (G2)\n|      \n(D1)\n|   \\\n|    E2\n|      \n(B1)\n|   \\\nA2   C2\n|      \n(02)\n\n(B1) has a red parent and is red\n(D1) has a red left child and is red</code></pre></div>\n<p>The next case is if the uncle is black or NULL, then rotate to the right around the grandparent.  </p>\n<p>The code is below:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>right <span class=\"token operator\">==</span> node<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">rotate_right_and_swap_colors</span><span class=\"token punctuation\">(</span>grandparent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If the node being inserted is to the right of the parent, it needs to be rotated to the left to keep one child to either side after the rotation.  If the left rotate isn't done first, the following will happen:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations FDGB\nF1\n| \\\nD2 G2\n|    \n(B2)\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\ni C\nF1\n| \\\nD2 G2\n|    \n(B2)\n    \\\n     (C2)\n\n(B2) has a red right child and is red\n(C2) has a red parent and is red\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\nr D\nF1\n| \\\n|  G2\n|    \nB2\n  \\\n   (D2)\n   |   \n   (C2)\n\n(C2) has a red parent and is red\n(D2) has a red left child and is red</code></pre></div>\n<p>This just created the inverse problem (D is to the right and C is to the left of D).  </p>\n<p>Notice that while swapping colors during the rotate, that the placement of the black node doesn't change. This maintains the proper black height.</p>\n<p>After inserting A, do a right rotation on its grandparent D because its uncle is NULL (NULL is black).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations FDGB\nF1\n| \\\nD2 G2\n|    \n(B2)\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\ni A\nF1\n| \\\nD2 G2\n|    \n(B2)\n|   \n(A2)\n\n(A2) has a red parent and is red\n(B2) has a red left child and is red\n\n(i)nsert, (e)rase, (r)ight_rotate, (l)eft_rotate, (R)ed, (b)lack, re(c)olor, (h)elp, (q)uit\nr D\nF1\n| \\\n|  G2\n|    \nB2\n| \\\n|  (D2)\n|      \n(A2)</code></pre></div>\n<p>In the example below, C is inserted to the left of B.  Both C and B are red.  Left rotate around B (the parent) before right rotating through D (the grandparent).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Starting with a valid red black tree\n====================================\nF1\n| \\\nD2 G2\n|    \n(B2)\n\n\nOperation: insert C\nF1\n| \\\nD2 G2\n|    \n(B2)\n    \\\n     (C2)\n\n(B2) has a red right child and is red\n(C2) has a red parent and is red\n\nOperation: left_rotate B\nF1\n| \\\nD2 G2\n|    \n(C2)\n|   \n(B2)\n\n(B2) has a red parent and is red\n(C2) has a red left child and is red\n\nOperation: right_rotate D\nF1\n| \\\n|  G2\n|    \nC2\n| \\\n|  (D2)\n|      \n(B2)</code></pre></div>\n<p>As stated before, the else block is where the parent is the right child, and the uncle is the left child.  All of the logic is reversed (left is swapped for right).</p>\n<p>To recap</p>\n<ol>\n<li>Link a node into the tree just like you would with a binary search tree</li>\n<li>Paint the node red</li>\n<li>Start a forever loop</li>\n<li>If the node doesn't have a parent, paint the node black and return</li>\n<li>If the node's parent is black, return</li>\n<li>If the node's uncle is not NULL and it is red\na. paint the parent and the uncle black\nb. paint the grandparent red\nc. set the node to be the grandparent and continue in loop (3)</li>\n<li>If the node is on the same side of the parent as the uncle is to the grandparent, rotate away from the uncle around the parent.</li>\n<li>Rotate towards the uncle around the grandparent, swap colors with the parent and the grandparent, and return.</li>\n</ol>\n<h2 id=\"erase\"><a href=\"#erase\" aria-label=\"erase permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Erase</h2>\n<p>Erasing nodes in a red black tree is more complex than insertion.  In writing this and trying to visualize what is happening, I needed to keep reminding myself of the importance of maintaining black height and to a lesser extent, the other rules (particularly that a node with only one child must have a red child).  Like insertion, node_erase calls a function to fix the balance of the tree once the node is removed.  A key difference is that the color doesn't always have to be fixed.  Another difference is that what fixed is either the parent or the successor.</p>\n<p>The function replace<em>node</em>with_child sets the child color to the node that it is replacing's color.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">child<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>color<span class=\"token punctuation\">;</span></code></pre></div>\n<p>If there is one child or if the node is the last in the tree, the color doesn't need to be fixed.  The only case in the block below where a node needs fixed is if you erase a black node without any children, that isn't the root.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>parent<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbool <span class=\"token function\">node_erase</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node_t <span class=\"token operator\">*</span>parent <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">replace_node_with_child</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>right<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>left <span class=\"token operator\">==</span> node<span class=\"token punctuation\">)</span>\n          parent<span class=\"token operator\">-></span>left <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">else</span>\n          parent<span class=\"token operator\">-></span>right <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n          <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">else</span>\n        <span class=\"token operator\">*</span>root <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">replace_node_with_child</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>left<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> root <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If you consider the following examples, it should be clear why erasing a red leaf is never a problem or a node with one child.</p>\n<p>The tree_operations has a -q feature which is less verbose (you don't get the menu or the list of operations that lead to a successful red-black tree structure).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ABC\nB1\n| \\\n|  (C1)\n|      \n(A1)\n\ne A\nB1\n  \\\n   (C1)\n\nThe above tree is a valid red black tree.\n\ne C\nB1\n\nThe above tree is a valid red black tree</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ABC\nB1\n| \\\n|  (C1)\n|      \n(A1)\n\ne A\nB1\n  \\\n   (C1)\n\nThe above tree is a valid red black tree.\n\ne B\nC1\n\nThe above tree is a valid red black tree</code></pre></div>\n<p>The case where fixing the color is important is shown below.  A has no children and is black.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ABCD\nB1\n| \\\nA2 C2\n     \\\n      (D2)\n\ne A\nB1\n  \\\n   C2\n     \\\n      (D2)\n\nB1 has one right child, and it isn&#39;t red</code></pre></div>\n<p>The rest of the erase method is to consider cases where the node being erased has two children.  If the successor is to the right (it doesn't have any left children), it will replace the node to erase as usual.  If the successor has a right child, then its child color will change to black (from red).  We can be assured that the successor's right child is red because it is an only child.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  node_t <span class=\"token operator\">*</span>successor <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>successor<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    size_t color <span class=\"token operator\">=</span> successor<span class=\"token operator\">-></span>color<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">replace_node_with_child</span><span class=\"token punctuation\">(</span>successor<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    successor<span class=\"token operator\">-></span>left <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n    successor<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> successor<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>successor<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span>\n      successor<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>successor<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p><b>An example where the successor has a right node:</b>  erasing F, G becomes successor, G has right child H.  </p>\n<ul>\n<li>Move G into F's spot.</li>\n<li>color G's right (H) black</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ABCDEFGH\nD1\n| \\\n|  (F1)\n|  |   \\\n|  E2   G2\n|         \\\n(B1)       (H2)\n|   \\          \nA2   C2\n\ne F\nD1\n| \\\n|  (G1)\n|  | \\\n|  E2 (H1)\n|         \n(B1)\n|   \\\nA2   C2\n\n(G1) has a red right child and is red\n(H1) has a red parent and is red\n(H1) has a different black height than A2\n\nb H\nD1\n| \\\n|  (G1)\n|  |   \\\n|  E2   H2\n|         \n(B1)\n|   \\\nA2   C2\n\nThe above tree is a valid red black tree</code></pre></div>\n<p><b>An example where the successor is black:</b> In this case, B is erased, C is the successor and is black.  C is colored the color of B.  The tree becomes invalid because C has a single black child (single children must be red).  The color must be fixed.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ABCDEFGH\nD1\n| \\\n|  (F1)\n|  |   \\\n|  E2   G2\n|         \\\n(B1)       (H2)\n|   \\          \nA2   C2\n\ne B\nD1\n| \\\n|  (F1)\n|  |   \\\n|  E2   G2\n|         \\\n(C1)       (H2)\n|              \nA2\n\n(C1) has one left child and it isn&#39;t red</code></pre></div>\n<p>Finally, an example where the successor is red.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ABC\nB1\n| \\\n|  (C1)\n|      \n(A1)\n\ne B\nC1\n|\n(A1)\n\nThe above tree is a valid red black tree</code></pre></div>\n<p>If the successor is to the left of the node to the right of the node to erase, then the normal erasing happens.  If the successor has a child, it would be right and red (because it would be the only child).  In this case, we replace the node that is going to be erased with both the successor and the successor that has the right child of the successor (in both cases, exchanging colors).  The node to the right of the successor will change to black because the successor started as black (because it only had one red child).</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>successor<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span>\n        successor <span class=\"token operator\">=</span> successor<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n\n      size_t color <span class=\"token operator\">=</span> successor<span class=\"token operator\">-></span>color<span class=\"token punctuation\">;</span>\n      node_t <span class=\"token operator\">*</span>right <span class=\"token operator\">=</span> successor<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n      node_t <span class=\"token operator\">*</span>parent <span class=\"token operator\">=</span> successor<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">;</span>\n      parent<span class=\"token operator\">-></span>left <span class=\"token operator\">=</span> right<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        right<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n        right<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">;</span>\n        color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">replace_node_with_child</span><span class=\"token punctuation\">(</span>successor<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      successor<span class=\"token operator\">-></span>left <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n      successor<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> successor<span class=\"token punctuation\">;</span>\n      successor<span class=\"token operator\">-></span>right <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n      successor<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> successor<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the example below H is erased and replaced with its successor (I).  I has a right child M which becomes a child of N and is colored black.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ACBFHEGPNIONM\nF1\n| \\\n|  H2\n|  | \\\n|  G3 (N2)\n|     |   \\\nB2    I3   P3\n| \\     \\  |\nA3 C3    | (O3)\n     \\   |     \n      |  (M3)\n      |      \n      (E3)\n\ne H\nF1\n| \\\n|  I2\n|  | \\\n|  G3 (N2)\n|     |   \\\nB2    (M2) P3\n| \\        |\nA3 C3      (O3)\n     \\         \n      (E3)\n\n(M2) has a red parent and is red\n(M2) has a different black height than A3\n(N2) has a red left child and is red\n\nb M\nF1\n| \\\n|  I2\n|  | \\\n|  G3 (N2)\n|     |   \\\nB2    M3   P3\n| \\        |\nA3 C3      (O3)\n     \\         \n      (E3)\n\nThe above tree is a valid red black tree</code></pre></div>\n<p>In the example below, H is erased (which is black) and replaced with I, which doesn't have a child.  The color must be fixed.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ACBFHEGPNION\nF1\n| \\\n|  H2\n|  | \\\n|  G3 (N2)\n|     |   \\\nB2    I3   P3\n| \\        |\nA3 C3      (O3)\n     \\         \n      (E3)\n\ne H\nF1\n| \\\n|  I2\n|  | \\\n|  G3 (N2)\n|         \\\nB2         P3\n| \\        |\nA3 C3      (O3)\n     \\         \n      (E3)\n\n(N2) has one right child and it isn&#39;t red</code></pre></div>\n<p>In the example below, N is erased (which is red) and replaced with O, which doesn't have a right child.  Because N is red, O will be red, and the overall tree height will be maintained.  The red black tree properties remain valid.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q ACBFHEGPNION\nF1\n| \\\n|  H2\n|  | \\\n|  G3 (N2)\n|     |   \\\nB2    I3   P3\n| \\        |\nA3 C3      (O3)\n     \\         \n      (E3)\n\ne N\nF1\n| \\\n|  H2\n|  | \\\n|  G3 (O2)\n|     |   \\\nB2    I3   P3\n| \\          \nA3 C3\n     \\\n      (E3)\n\nThe above tree is a valid red black tree</code></pre></div>\n<h2 id=\"quick-recap-of-when-tree-becomes-invalid\"><a href=\"#quick-recap-of-when-tree-becomes-invalid\" aria-label=\"quick recap of when tree becomes invalid permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Quick recap of when tree becomes invalid</h2>\n<ul>\n<li>The node to erase has no children, is black, and has a parent.  The node's parent is invalid.</li>\n<li>The node to erase has two children, the successor was originally black, and the successor did not have a right child.  The successor's original parent is invalid (this is the successor itself when the successor is to the right of the node<em>to</em>erase since it replaced its parent).</li>\n</ul>\n<p>It's worth noting that when you erase a node and use a successor, that you are erasing the successor and putting it in place of the node to erase.  That's why in the first case, the parent of the node to erase is used, and in the second case, the parent of the successor is used.</p>\n<h2 id=\"fixcolorfor_erase\"><a href=\"#fixcolorfor_erase\" aria-label=\"fixcolorfor_erase permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fix<em>color</em>for_erase</h2>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>parent<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node_t <span class=\"token operator\">*</span>sibling<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>right <span class=\"token operator\">!=</span> node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    sibling <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      sibling <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          sibling<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n          <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>sibling<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent <span class=\"token operator\">&amp;&amp;</span> parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n              <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">else</span>\n              parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>sibling<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sibling<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent <span class=\"token operator\">&amp;&amp;</span> parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">else</span>\n        parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    sibling <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      sibling <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          sibling<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n          <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>sibling<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent <span class=\"token operator\">&amp;&amp;</span> parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n              <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">else</span>\n              parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>sibling<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sibling<span class=\"token operator\">-></span>left<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent <span class=\"token operator\">&amp;&amp;</span> parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">else</span>\n        parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The fix<em>color</em>for_erase function is large but can split into sections that largely mirror each other.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>node_t <span class=\"token operator\">*</span>parent<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> node_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node_t <span class=\"token operator\">*</span>sibling<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>right <span class=\"token operator\">!=</span> node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    sibling <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    sibling <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>left<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The only difference between the if and the else statement is that every left and right are swapped.  The rest of the explanation will focus on where the sibling is on the right.</p>\n<p>The insert color fixing method of the red black tree uses the uncle's color to help decide actions.  The erase color fixing method uses the sibling.  If the sibling is red, we can rotate away from the sibling around the parent and set the sibling to be the parent's right node.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  sibling <span class=\"token operator\">=</span> parent<span class=\"token operator\">-></span>right<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the example below, erase A, the sibling is O (which is red), and the parent is E:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ $ac/bin/tree_operations -q AEIOUY\nE1\n| \\\nA2 (O1)\n   |   \\\n   I2   U2\n          \\\n           (Y2)\n\ne A\nE1\n  \\\n   (O1)\n   |   \\\n   I2   U2\n          \\\n           (Y2)\n\nE1 has a NULL left child with a different black height than I2\n\nl E\nO1\n| \\\n|  U2\n|    \\\n|     (Y2)\n|         \n(E1)\n    \\\n     I2\n\n(E1) has a NULL left child with a different black height than I2\n(E1) has one right child and it isn&#39;t red</code></pre></div>\n<p>After the rotation, E becomes red, and I becomes the sibling that is black.  </p>\n<p>To recap: if the sibling is red, rotate away from the sibling and set the sibling to be equal to what is on the same side of the parent again.  The sibling will be black, and we can proceed with the cases which expect the sibling to be black.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>right <span class=\"token operator\">&amp;&amp;</span> sibling<span class=\"token operator\">-></span>right <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  sibling<span class=\"token operator\">-></span>right<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sibling<span class=\"token operator\">-></span>left <span class=\"token operator\">&amp;&amp;</span> sibling<span class=\"token operator\">-></span>left <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>sibling<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  sibling<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent <span class=\"token operator\">&amp;&amp;</span> parent<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">fix_color_for_erase</span><span class=\"token punctuation\">(</span>parent<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">else</span>\n    parent<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><b>If the sibling is to the right and is black:</b></p>\n<p>First, check to see if the sibling's right child is red.  If it is, color it black and rotate left around the parent.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">EXAMPLE</code></pre></div>\n<p>If not, check if the sibling's left child is red.  If it is, rotate right around the sibling, then left around the parent.  Finally, color the sibling black (the rotations will have changed the sibling's color).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">EXAMPLE</code></pre></div>\n<p>Finally, if neither of the sibling's children are red, color the sibling red.  If the parent is red or is the root, color the parent black.  Otherwise, fix the color for the parent's parent and set the node to pair up with a sibling to be the parent.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">EXAMPLE</code></pre></div>\n<h2 id=\"packing-color-into-the-parent-node\"><a href=\"#packing-color-into-the-parent-node\" aria-label=\"packing color into the parent node permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Packing color into the parent node</h2>\n<p>The code for this section is found in <i>illustrations/12<em>red</em>black<em>tree/2</em>red<em>black</em>tree</i></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd $ac/illustrations/12_red_black_tree/2_red_black_tree\nmake</code></pre></div>\n<p>The red<em>black</em>tree code above used the following node data structure.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">node_s</span> <span class=\"token punctuation\">{</span>\n  size_t color<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">node_s</span> <span class=\"token operator\">*</span>parent<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">node_s</span> <span class=\"token operator\">*</span>left<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">node_s</span> <span class=\"token operator\">*</span>right<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">char</span> key<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This requires 8 bytes (on a 64-bit machine) for the color and 8 bytes for the parent.  Since pointers to structures are typically aligned, we can use the 0 bit of the parent for the color and save 8 bytes per node structure.  Our new structure will look like.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">node_s</span> <span class=\"token punctuation\">{</span>\n  size_t parent_color<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">node_s</span> <span class=\"token operator\">*</span>left<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">node_s</span> <span class=\"token operator\">*</span>right<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">char</span> key<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We can then use the following #define macros to access and set the parent node and the color.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_color(n) ((n)->parent_color &amp; 1)</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_is_red(n) (((n)->parent_color &amp; 1) == 0)</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_is_black(n) (((n)->parent_color &amp; 1) == 1)</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_parent(n) (node_t *)((n)->parent_color - ((n)->parent_color &amp; 1))</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_set_black(n) (n)->parent_color |= 1</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_set_red(n) (n)->parent_color -= ((n)->parent_color &amp; 1)</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_set_parent(n, parent) (n)->parent_color = ((n)->parent_color &amp; 1) + (size_t)(parent)</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> rb_clear_black(n) (n)->parent_color = 1</span></code></pre></div>\n<p>The rest of the change involves converting code, which accesses the parent pointer or the color to one of these macros.  You can run the following command to find all of the diffs.  I'll show a few.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">diff red_black_tree.c ../1_red_black_tree/red_black_tree.c | less</code></pre></div>\n<p>rb_parent</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">n <span class=\"token operator\">=</span> n<span class=\"token operator\">-></span>parent<span class=\"token punctuation\">;</span></code></pre></div>\n<p>becomes</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">n <span class=\"token operator\">=</span> <span class=\"token function\">rb_parent</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<br/>\n<p>rb<em>set</em>red</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">n<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span></code></pre></div>\n<p>becomes</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">rb_set_red</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<br/>\n<p>rb<em>is</em>red</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span></code></pre></div>\n<p>becomes</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">rb_is_red</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br/>\n<br/>\n<p>rb<em>clear</em>black</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">n<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\nn<span class=\"token operator\">-></span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span></code></pre></div>\n<p>becomes</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">rb_clear_black</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>and so on.</p>\n<p><a href=\"../../../README.md\">Table of Contents (only if viewing on Github)</a></p>","frontmatter":{"title":"12. The Red-Black Tree","posttype":"ebook"}},"allMarkdownRemark":{"edges":[{"node":{"id":"65ef6af8-db2b-5241-aabb-be94ecaa93a6","frontmatter":{"title":"","path":null,"posttype":null},"headings":[{"value":"Line spacing in markdown"},{"value":"Escape characters in markdown"},{"value":"Create multiline macro in C"},{"value":"Static inline vs inline"},{"value":"Regex find replace"},{"value":"Atom-beautify problems"}]}},{"node":{"id":"ea93de22-255a-510a-a3d6-e5ca71719254","frontmatter":{"title":"","path":null,"posttype":null},"headings":[{"value":"An important intuition to quicksort"}]}},{"node":{"id":"e92ffe3f-7ca9-5998-86d0-02a589e5a259","frontmatter":{"title":"1. Getting Started","path":"/1-getting-started","posttype":"ebook"},"headings":[]}},{"node":{"id":"b16eb4e9-d84b-5be6-84f7-61ebe2bcc410","frontmatter":{"title":"10. Binary Search Trees","path":"/10-binary-search-trees","posttype":"ebook"},"headings":[{"value":"The basic structure"},{"value":"First, Last, Next, Previous"},{"value":"Erase"},{"value":"Postorder iteration"},{"value":"Printing a binary tree"},{"value":"Finding Peers"},{"value":"Quick Recap"}]}},{"node":{"id":"baba82da-4489-5fd7-9915-ef011f56a666","frontmatter":{"title":"11. Balancing Binary Search Trees","path":"/11-balancing-binary-search-trees","posttype":"ebook"},"headings":[{"value":"Why balancing is important"},{"value":"Properties of a red-black tree"},{"value":"Coloring"},{"value":"Rotations"}]}},{"node":{"id":"f2d454de-1f32-50a9-91a3-f3ed53776f11","frontmatter":{"title":"12. The Red-Black Tree","path":"/12-red-black-tree","posttype":"ebook"},"headings":[{"value":"The properties of a red-black tree"},{"value":"Testing the red-black tree properties"},{"value":"Insert"},{"value":"Erase"},{"value":"Quick recap of when tree becomes invalid"},{"value":"fixcolorfor_erase"},{"value":"Packing color into the parent node"}]}},{"node":{"id":"0229f92a-6f18-52a2-9a98-c536b17b48fa","frontmatter":{"title":"13. The Map Object","path":"/13-map","posttype":"ebook"},"headings":[]}},{"node":{"id":"d40dca2d-317c-5be1-96bb-1a1ce5aa709b","frontmatter":{"title":"14. The Set and Multimap","path":"/14-set-and-multimap","posttype":"ebook"},"headings":[{"value":"The set"},{"value":"The multimap"}]}},{"node":{"id":"dda89e39-e139-5921-b61e-3428acc8db29","frontmatter":{"title":"2. Timing Your Code","path":"/2-timing","posttype":"ebook"},"headings":[{"value":"A brief introduction to C"},{"value":"The void type"},{"value":"What happens during compilation"},{"value":"How to time code"},{"value":"Reversing a string"},{"value":"The basic Makefile"},{"value":"More accurately timing code"},{"value":"Doing a better job of timing continued"},{"value":"Compiler optimizations"},{"value":"Splitting up your code into multiple files part 2"},{"value":"Separating the implementation from the interface"},{"value":"Separating the implementation from the interface (part 2)"},{"value":"Defining an object"},{"value":"The timer interface"},{"value":"Making the timer object reusable"},{"value":"Splitting up a project into multiple directories"},{"value":"Splitting up the Makefile"}]}},{"node":{"id":"9801a3af-8f22-5982-94c5-35f6112eb823","frontmatter":{"title":"3. The Buffer Object","path":"/3-buffer","posttype":"ebook"},"headings":[{"value":"How it compares to other languages"},{"value":"A bit of history and setup"},{"value":"The buffer interface"},{"value":"The implementation"}]}},{"node":{"id":"711af732-1367-5fd2-9136-ab310ae70a1c","frontmatter":{"title":"4. Linked Lists","path":"/4-linked-lists","posttype":"ebook"},"headings":[{"value":"A data structure interface"},{"value":"The data structure interface test driver"},{"value":"The singly linked list"},{"value":"The doubly linked list"}]}},{"node":{"id":"3f9e59fa-f5a7-5d87-95d8-40c4b5a27155","frontmatter":{"title":"5. Introducing Threads","path":"/5-threads","posttype":"ebook"},"headings":[{"value":"Introducing threads"},{"value":"Creating threads"},{"value":"Threads and optimizing code"},{"value":"Avoid global variables when you can"},{"value":"Mutexes"},{"value":"Timing considerations"}]}},{"node":{"id":"14b23037-d39b-5c6a-8575-87c49f29e5bf","frontmatter":{"title":"6. Macros","path":"/6-macros","posttype":"ebook"},"headings":[]}},{"node":{"id":"1f7d377b-cb76-56c9-ab8e-65e6f347a63b","frontmatter":{"title":"7. The Global Allocator Object","path":"/7-allocator","posttype":"ebook"},"headings":[]}},{"node":{"id":"836c39a4-58c3-5e44-973e-2eaee112e590","frontmatter":{"title":"8. The Global Allocator Implementation","path":"/8-allocator-implementation","posttype":"ebook"},"headings":[{"value":"Keywords used"},{"value":"Symbols used"}]}},{"node":{"id":"c0fc3845-5a1d-5561-b1ce-e06b57e99af8","frontmatter":{"title":"9. The Pool Object","path":"/9-pool","posttype":"ebook"},"headings":[]}},{"node":{"id":"065c3ab5-419a-554d-a220-4897a1a6534e","frontmatter":{"title":"ac_allocator","path":"/ac-allocator","posttype":"docs"},"headings":[{"value":"Dependencies"},{"value":"Documentation"},{"value":"Detecting Memory Errors"},{"value":"Double Free"},{"value":"Freeing the Wrong Memory"},{"value":"Tracking Memory Loss Over Time"},{"value":"Advanced Usage"}]}},{"node":{"id":"fab92a85-30fc-5a12-9164-22ce6f6fa580","frontmatter":{"title":"ac_pool","path":"/ac-pool","posttype":"docs"},"headings":[{"value":"Dependencies"}]}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/ebook/12-red-black-tree/"}}}