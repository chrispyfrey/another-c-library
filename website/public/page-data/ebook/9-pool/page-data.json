{"componentChunkName":"component---src-templates-ebook-page-js","path":"/ebook/9-pool/","result":{"data":{"site":{"siteMetadata":{"title":"Another C Library"}},"markdownRemark":{"id":"c0fc3845-5a1d-5561-b1ce-e06b57e99af8","html":"<h1 id=\"the-pool-object\"><a href=\"#the-pool-object\" aria-label=\"the pool object permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Pool Object</h1>\n<p>What if our object could keep track of allocations and free memory for us?  This is generally the basis for languages that use garbage collection.  I'm going to illustrate how to build several objects which greatly reduce the number of calls to malloc and free (and reduce the risk that you will have memory leaks).  </p>\n<p>The first is an object which I've used for almost my whole career.  I've called it a pool.  The basic idea with this object is that you can allocate and clear.  It has no free function.  When you clear, you clear all of the memory that has been previously allocated from the pool. Internally, it is very efficient in that all it typically does is reset a counter to zero.  The base interface will look something like the following.</p>\n<p>pool.h</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">ifndef</span> _pool_H</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> _pool_H</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">pool_s</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">pool_s</span> pool_t<span class=\"token punctuation\">;</span>\n\npool_t <span class=\"token operator\">*</span><span class=\"token function\">pool_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pool_malloc</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pool_calloc</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">pool_strdup</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">pool_clear</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">pool_destroy</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<p>There is no free method.  You can call the allocation methods as often as you like, and they will remain valid until pool<em>clear or pool</em>destroy is called.</p>\n<h1 id=\"the-simplest-implementation\"><a href=\"#the-simplest-implementation\" aria-label=\"the simplest implementation permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Simplest Implementation</h1>\n<p>When approaching algorithms, it is often a good idea to think about the simplest implementation.  This implementation doesn't need to be efficient.  It can serve to prove that a more complicated version achieves the same result.</p>\n<p>Below describes a simple implementation of the pool interface:</p>\n<ul>\n<li>Have each allocation saved in a singly linked list on the pool_s structure.  </li>\n<li>The clear method could free all of the memory in the linked list.</li>\n<li>The destroy could call clear, and then free the pool_s object itself.</li>\n<li>Each allocation would require it's own link structure.</li>\n</ul>\n<p>A singly linked list usually is linked to from a structure and then chained together using a member called next.  Each allocation would be placed in its own structure and linked to by the pool_s structure through the member head.  The two objects and implementation would probably look like the following.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">pool_node_s</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>m<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">pool_node_s</span> <span class=\"token operator\">*</span>next<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> pool_node_t<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">pool_s</span> <span class=\"token punctuation\">{</span>\n  pool_node_t <span class=\"token operator\">*</span>head<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\npool_t <span class=\"token operator\">*</span><span class=\"token function\">pool_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  pool_t <span class=\"token operator\">*</span>r <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>pool_t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  r<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> r<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pool_malloc</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  pool_node_t <span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>pool_node_t <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>pool_node_t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  n<span class=\"token operator\">-></span>m <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span>len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  n<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> h<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span>\n  h<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> n<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> n<span class=\"token operator\">-></span>m<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pool_calloc</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>m <span class=\"token operator\">=</span> <span class=\"token function\">pool_malloc</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> m<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">pool_strdup</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>m <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">pool_malloc</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> m<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">pool_clear</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  pool_node_t <span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> h<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pool_node_t <span class=\"token operator\">*</span>next <span class=\"token operator\">=</span> n<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-></span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    n <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">pool_destroy</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">pool_clear</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We could allocate the desired memory and the pool<em>node</em>t structure together.  If we did that, we wouldn't need the void *m parameter, and the memory requested could just exist after the pool<em>node</em>t structure.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">pool_node_s</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">pool_node_s</span> <span class=\"token operator\">*</span>next<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> pool_node_t<span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pool_malloc</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  pool_node_t <span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>pool_node_t <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>pool_node_t<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  n<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> h<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span>\n  h<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> n<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">pool_clear</span><span class=\"token punctuation\">(</span>pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  pool_node_t <span class=\"token operator\">*</span>n <span class=\"token operator\">=</span> h<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pool_node_t <span class=\"token operator\">*</span>next <span class=\"token operator\">=</span> n<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// free(n->m); // this is no longer needed</span>\n    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    n <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using the simple structure above, our allocations can be tracked and cleared by the pool object instead of requiring the application to remember where each allocation started from.</p>\n<h1 id=\"a-better-implementation\"><a href=\"#a-better-implementation\" aria-label=\"a better implementation permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A better implementation</h1>\n<p>The above implementation does save us from needing to free memory, but it doesn't do much more.  The pool object that exists in the src directory is listed below:</p>\n<p>src/ac_pool.h</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">ifndef</span> _ac_pool_H</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> _ac_pool_H</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdarg.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ac_allocator.h\"</span></span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ac_pool_s</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">ac_pool_s</span> ac_pool_t<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_init will create a working space of size bytes */</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">ifdef</span> _AC_DEBUG_MEMORY_</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO(\"ac_pool\"))</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size)</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span>\n\n<span class=\"token comment\">/* ac_pool_clear will make all of the pool's memory reusable.  If the\n  initial block was exceeded and additional blocks were added, those blocks\n  will be freed. */</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">ac_pool_clear</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_destroy frees up all memory associated with the pool object */</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">ac_pool_destroy</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_set_minimum_growth_size alters the minimum size of growth blocks.\n   This is particularly useful if you don't expect the pool's block size to be\n   exceeded by much, and you don't want the default, which would be to use the\n   original block size for the new block (effectively doubling memory usage). */</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">ac_pool_set_minimum_growth_size</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_alloc allocates len uninitialized bytes which are aligned. */</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_alloc</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_alloc allocates len uninitialized bytes which are unaligned. */</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_ualloc</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_alloc allocates len zero'd bytes which are aligned. */</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_calloc</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_strdup allocates a copy of the string p.  The memory will be\n  unaligned.  If you need the memory to be aligned, consider using ac_pool_dup\n  like char *s = ac_pool_dup(pool, p, strlen(p)+1); */</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_strdup</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_dup allocates a copy of the data.  The memory will be aligned. */</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_dup</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>data<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_dup allocates a copy of the data.  The memory will be unaligned. */</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_udup</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>data<span class=\"token punctuation\">,</span> size_t len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_strdupf allocates a copy of the formatted string p. */</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_strdupf</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_strdupvf allocates a copy of the formatted string p. This is\n  particularly useful if you wish to extend another object which uses pool as\n  its base.  */</span>\n<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_strdupvf</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">,</span> va_list args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_size returns the number of bytes that have been allocated from any\n  of the alloc calls above.  */</span>\nsize_t <span class=\"token function\">ac_pool_size</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* ac_pool_used returns the number of bytes that have been allocated by the\n  pool itself.  This will always be greater than ac_pool_size as there is\n  overhead for the structures, and this is independent of any allocating calls.\n*/</span>\nsize_t <span class=\"token function\">ac_pool_used</span><span class=\"token punctuation\">(</span>ac_pool_t <span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">\"impl/ac_pool.h\"</span></span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<p>A few significant changes are added to the interface.</p>\n<ul>\n<li>Everything uses the ac_ prefix.</li>\n<li>The ac_allocator object is used for allocation.</li>\n<li>ac<em>pool</em>init is changed to a macro to support memory debugging.</li>\n<li>ac<em>pool</em>init takes in a size (to support allocating in larger chunks)</li>\n<li>ac<em>pool</em>malloc is changed to ac<em>pool</em>alloc.</li>\n<li>ac<em>pool</em>ualloc supports unaligned allocation.</li>\n<li>ac<em>pool</em>dup and sla<em>pool</em>udup copy binary data.</li>\n<li>ac<em>pool</em>strdupf/ac<em>pool</em>strdupvf support working with format strings.</li>\n<li>ac<em>pool</em>size gets the overall number of bytes that have been allocated.</li>\n<li>ac<em>pool</em>used gets the overall number of bytes that have been allocated internally.</li>\n<li>impl/ac_pool.h is used to inline a number of the functions for performance.</li>\n<li>some of the functions are declared as static inline because they are implemented in the impl/ac_pool.h header file.</li>\n</ul>\n<p>By this point, the code below should look pretty familiar.  Files are included, ac<em>pool</em>t is defined, and the <em>ac</em>pool_H is defined to prevent the contents of this file from being included more than once.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">ifndef</span> _ac_pool_H</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> _ac_pool_H</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdarg.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ac_allocator.h\"</span></span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ac_pool_s</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">ac_pool_s</span> ac_pool_t<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Because this object will use the ac_allocator for debugging memory, the following is needed to define the init function.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/* ac_pool_init will create a working space of size bytes */</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">ifdef</span> _AC_DEBUG_MEMORY_</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO(\"ac_pool\"))</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size)</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<p>If we weren't using the ac_allocator, our init call would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">ac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If you refer back to the end of the <a href=\"../7-allocator/index.md\">allocator</a> code, there is an explanation of similar code for the timer object conversion.</p>\n<p>Replace</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">ac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>with</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">ifdef</span> _AC_DEBUG_MEMORY_</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO(\"ac_pool\"))</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size)</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<p>The above code has two basic cases:  one where <em>AC</em>DEBUG<em>MEMORY</em> is defined, and the other where it is not (#else).  It may be easier to break this into a couple of steps.</p>\n<ol>\n<li>convert the init function to be prefixed with an underscore</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">ac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>becomes</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">ac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ol start=\"2\">\n<li>\n<p>create a macro which defines ac<em>pool</em>init as <em>ac</em>pool_init</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size)</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>\n<p>define the macro if logic with the else part filled in.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">ifdef</span> _AC_DEBUG_MEMORY_</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size)</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span></code></pre></div>\n</li>\n<li>\n<p>Add const char *caller to the debug version of <em>ac</em>pool_init</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">ac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>\n<p>define the macro to call the init function.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO(\"ac_pool\"))</span></code></pre></div>\n</li>\n<li>\n<p>put the two calls in the #ifdef <em>AC</em>DEBUG<em>MEMORY</em> section.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">ifdef</span> _AC_DEBUG_MEMORY_</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size, AC_FILE_LINE_MACRO(\"ac_pool\"))</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> ac_pool_init(size) _ac_pool_init(size)</span>\nac_pool_t <span class=\"token operator\">*</span><span class=\"token function\">_ac_pool_init</span><span class=\"token punctuation\">(</span>size_t size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span></code></pre></div>\n</li>\n</ol>\n<p>A common use case for the pool is to allocate a bunch of times and then clear and repeat.  For example, if you were responding to queries from a search engine, you might want to use this object and allocate a bunch of times for parsing the query and building a response.  Once the response has been written, the pool can be cleared and used for the next query.  The pool would likely need a certain amount of bytes to satisfy the vast majority of the queries.  Given this use, it makes sense for the pool to allocate enough bytes in a single block, and then just to dole out the memory via its allocation methods.  If the single block isn't big enough for all of the allocations, overflow blocks will be allocated.  When the pool is cleared, the overflow blocks will be freed.  The main block will remain, and the counter inside the pool will be reset to zero.  If we make the pool too small, the overflow blocks will continuously get used.  If we make it too big, we waste memory.</p>\n<h1 id=\"to-be-continued\"><a href=\"#to-be-continued\" aria-label=\"to be continued permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TO BE CONTINUED</h1>\n<p><a href=\"../../../README.md\">Table of Contents (only if viewing on Github)</a></p>","frontmatter":{"title":"9. The Pool Object"}},"allMarkdownRemark":{"edges":[{"node":{"id":"65ef6af8-db2b-5241-aabb-be94ecaa93a6","frontmatter":{"title":"","path":null},"headings":[{"value":"Things that have been helpful to me"}]}},{"node":{"id":"ea93de22-255a-510a-a3d6-e5ca71719254","frontmatter":{"title":"","path":null},"headings":[{"value":"Improving Quicksort"},{"value":"The Improvement to Quicksort"}]}},{"node":{"id":"e92ffe3f-7ca9-5998-86d0-02a589e5a259","frontmatter":{"title":"1. Getting Started","path":"/1-getting-started"},"headings":[{"value":"A quick word about licensing"},{"value":"Getting Started"}]}},{"node":{"id":"b16eb4e9-d84b-5be6-84f7-61ebe2bcc410","frontmatter":{"title":"10. Binary Search Trees","path":"/10-binary-search-trees"},"headings":[{"value":"Binary Search Trees"},{"value":"Find"},{"value":"Insert"}]}},{"node":{"id":"baba82da-4489-5fd7-9915-ef011f56a666","frontmatter":{"title":"11. Balancing Binary Search Trees","path":"/11-balancing-binary-search-trees"},"headings":[{"value":"Balancing Binary Search Trees"}]}},{"node":{"id":"f2d454de-1f32-50a9-91a3-f3ed53776f11","frontmatter":{"title":"12. The Red-Black Tree","path":"/12-red-black-tree"},"headings":[{"value":"The Red-Black Tree"}]}},{"node":{"id":"0229f92a-6f18-52a2-9a98-c536b17b48fa","frontmatter":{"title":"13. The Map Object","path":"/13-map"},"headings":[{"value":"The Map Object"}]}},{"node":{"id":"d40dca2d-317c-5be1-96bb-1a1ce5aa709b","frontmatter":{"title":"14. The Set and Multimap","path":"/14-set-and-multimap"},"headings":[{"value":"The set and multimap"}]}},{"node":{"id":"dda89e39-e139-5921-b61e-3428acc8db29","frontmatter":{"title":"2. Timing Your Code","path":"/2-timing"},"headings":[{"value":"Timing Your Code (the first project)"},{"value":"Splitting up code into multiple files"},{"value":"include <stdlib.h> is added at the top of the file since it is needed for malloc.  All of the members are initialized to zero except repeat (which is set to the value passed into timer_init)."}]}},{"node":{"id":"9801a3af-8f22-5982-94c5-35f6112eb823","frontmatter":{"title":"3. The Buffer Object","path":"/3-buffer"},"headings":[{"value":"The Buffer Object"}]}},{"node":{"id":"711af732-1367-5fd2-9136-ab310ae70a1c","frontmatter":{"title":"4. Linked Lists","path":"/4-linked-lists"},"headings":[{"value":"Linked Lists"}]}},{"node":{"id":"3f9e59fa-f5a7-5d87-95d8-40c4b5a27155","frontmatter":{"title":"5. Introducing Threads","path":"/5-threads"},"headings":[]}},{"node":{"id":"14b23037-d39b-5c6a-8575-87c49f29e5bf","frontmatter":{"title":"6. Macros","path":"/6-macros"},"headings":[{"value":"Macros"}]}},{"node":{"id":"1f7d377b-cb76-56c9-ab8e-65e6f347a63b","frontmatter":{"title":"7. The Global Allocator Object","path":"/7-allocator"},"headings":[{"value":"The Global Allocator Object"},{"value":"A Quick Recap"}]}},{"node":{"id":"836c39a4-58c3-5e44-973e-2eaee112e590","frontmatter":{"title":"8. The Global Allocator Implementation","path":"/8-allocator-implementation"},"headings":[{"value":"The Global Allocator Implementation"},{"value":"To Be Continued"}]}},{"node":{"id":"c0fc3845-5a1d-5561-b1ce-e06b57e99af8","frontmatter":{"title":"9. The Pool Object","path":"/9-pool"},"headings":[{"value":"The Pool Object"},{"value":"The Simplest Implementation"},{"value":"A better implementation"},{"value":"TO BE CONTINUED"}]}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/ebook/9-pool/"}}}